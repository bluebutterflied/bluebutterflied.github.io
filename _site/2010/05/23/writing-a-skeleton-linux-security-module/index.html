<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet"> -->
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:600,600i,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet"> 

<link rel="stylesheet" href="/assets/css/tailwind.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/cards.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100&display=swap" rel="stylesheet">
<title>Writing a Skeleton Linux Security Module</title>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125808593-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125808593-1');
</script>



<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Writing a Skeleton Linux Security Module | recluze - Nauman (recluze) on Computing, Philosophy and More …</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Writing a Skeleton Linux Security Module" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I recently had to write a Linux Security Module (LSM) for one of my research projects and I was surprised to find that there are few tutorials out there and most of them don’t work because of the discrepencies in kernel versions. They’re talking about 2.000.x kernel versions! The only good tutorial I came across was the one on Linux Journal but it assumed some background knowledge (which I didn’t have). So, I had to struggle for a day to figure out how to go about writing the LSM. Hence, this tutorial." />
<meta property="og:description" content="I recently had to write a Linux Security Module (LSM) for one of my research projects and I was surprised to find that there are few tutorials out there and most of them don’t work because of the discrepencies in kernel versions. They’re talking about 2.000.x kernel versions! The only good tutorial I came across was the one on Linux Journal but it assumed some background knowledge (which I didn’t have). So, I had to struggle for a day to figure out how to go about writing the LSM. Hence, this tutorial." />
<meta property="og:site_name" content="recluze - Nauman (recluze) on Computing, Philosophy and More …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2010-05-23T11:14:38+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Writing a Skeleton Linux Security Module" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Writing a Skeleton Linux Security Module","dateModified":"2010-05-23T11:14:38+05:00","datePublished":"2010-05-23T11:14:38+05:00","description":"I recently had to write a Linux Security Module (LSM) for one of my research projects and I was surprised to find that there are few tutorials out there and most of them don’t work because of the discrepencies in kernel versions. They’re talking about 2.000.x kernel versions! The only good tutorial I came across was the one on Linux Journal but it assumed some background knowledge (which I didn’t have). So, I had to struggle for a day to figure out how to go about writing the LSM. Hence, this tutorial.","url":"/2010/05/23/writing-a-skeleton-linux-security-module/","mainEntityOfPage":{"@type":"WebPage","@id":"/2010/05/23/writing-a-skeleton-linux-security-module/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="texture-blue">
    <div class="container"><div class="navbar">
	<ul>
		
		<a href="/"><li  >Home</li></a>
		
		<a href="/about"><li  >About</li></a>
		
		<a href="/learn"><li  >Courses</li></a>
		
	</ul>
</div></div><div class="container">
	<h1>Writing a Skeleton Linux Security Module</h1>
	<h4 class="post-description"></h4>
	<div class="post-date" style="margin-top:20px">
		Published on May 23, 2010
	</div>
	<ul class="post-tags"><li>Articles</li><li>Geek stuff</li><li>Linux</li><li>Tutorials</li></ul>
</div>
</header>
  <main>
    <div class="container">
      <div class="post-container">
          <p>I recently had to write a Linux Security Module (LSM) for one of my research projects and I was surprised to find that there are few tutorials out there and most of them don’t work because of the discrepencies in kernel versions. They’re talking about 2.000.x kernel versions! The only good tutorial I came across was the one on <a href="http://www.linuxjournal.com/article/6279">Linux Journal</a> but it assumed some background knowledge (which I didn’t have). So, I had to struggle for a day to figure out how to go about writing the LSM. Hence, this tutorial.</p>

<p>Now, this isn’t strictly a newbie tutorial. It isn’t even a tutorial per se. It’s more like a guideline that will tell you where to look to find what you need. The reason is that if I write something specific, it’ll go out-of-date in a giffy. So, I’ll tell you the process of how I figured out the steps and you can (probably) reproduce them even if the specifics have changed. This might not be the best way to do it but it certainly gets you going. I had to take quite a few detours to get to these steps; so they might save you some time. Ok, let’s go.<br />
<!--more--></p>

<p>First, I read up on what an LSM is. (If you’re reading this, you probably know what it is.) Then, I came across the tlj link I mentioned <a href="http://www.linuxjournal.com/article/6279">earlier</a> and read what <code class="language-plaintext highlighter-rouge">register_security</code> function, <code class="language-plaintext highlighter-rouge">security_operations</code> struct and others do.</p>

<p>Then, I went ahead and created a directory in the security folder of the linux kernel source. (I used linux-2.6.33.3, so the I’ll assume the source is sitting in <code class="language-plaintext highlighter-rouge">/usr/src/linux-2.6.33.3</code>) Assume the name of the LSM is <code class="language-plaintext highlighter-rouge">blabbermouth</code> (since it does nothing but printk the hooks).</p>

<p>To tell the kernel build about your LSM, I needed to do three things: (1) Create a Makefile. That’s simple. See <a href="http://sites.google.com/site/naumanrecly/Home/blabbermouth.tar.gz?attredirects=0&amp;d=1">this archive</a> for the files and patches. (2) Create a Kconfig file. Again, fairly straight forward for a skeleton LSM. (3) Tell the security Makefile and Kconfig files about my LSM i.e. Edit <code class="language-plaintext highlighter-rouge">security/Makefile</code> and <code class="language-plaintext highlighter-rouge">security/Kconfig</code>. (See the two patch files in the archive to figure out where to insert the new lines.)</p>

<p>Once that is out of the way, I needed the actual source of the LSM. So, I created the blabbermouth.c fie. Now, the first thing was to create an instance of the security_ops structure. This is complicated because there are several fields in this and if you don’t have a good IDE, this is going to be tough. Of course, you have the kernel source so you can simply “borrow” code from elsewhere. I went to <code class="language-plaintext highlighter-rouge">security/selinux/hooks.c</code> and copied me a nice tidy <code class="language-plaintext highlighter-rouge">security_operations</code> struct (you can find it right at the bottom). Of course, it points to different functions in the same file so I got those too. By the way, you can find the declaration of the <code class="language-plaintext highlighter-rouge">security_operations</code> structure in <code class="language-plaintext highlighter-rouge">include/linux/security.h</code></p>

<p>Changed all the <code class="language-plaintext highlighter-rouge">selinux_*</code> function names to <code class="language-plaintext highlighter-rouge">blabbermouth_*</code> function names and replaced the bodies of all these functions with a <code class="language-plaintext highlighter-rouge">return 0</code>; Hence the name “skeleton LSM”. I also inserted some printk statements just so that I’d know that the thing was working.</p>

<p>Of course, when you’re working with the kernel, you have to make sure you cater to the configurations. So, I surrounded the relevant portions with the <code class="language-plaintext highlighter-rouge">#ifdef CONFIG_SECURITY_BLABBERMOUTH</code> and <code class="language-plaintext highlighter-rouge">#endif</code> to make sure it only gets built if configured as such.</p>

<p>Once that is out of the way, I created a new initialization function with <code class="language-plaintext highlighter-rouge">void __init blabbermouth_init</code> and told the module to call it on initialization through <code class="language-plaintext highlighter-rouge">module_init</code> macro. Also created an <code class="language-plaintext highlighter-rouge">__ exit blabbermouth_exit</code> function and registered it through <code class="language-plaintext highlighter-rouge">module_exit</code>.</p>

<p>Phew. That was fun. Now, back to make menuconfig and selected the blabbermouth module from the security page.</p>

<p>Make, make modules_install and make install and I was good to go. Felt good to see the blabbermouth outputs in <code class="language-plaintext highlighter-rouge">dmesg</code>.</p>


      </div>

        <!-- Configure Disqus --></div>
  </main><footer class="footer">
  <span class="text-muted"> recluze | No rights reserved.</span>
</footer>
</body>
</html>