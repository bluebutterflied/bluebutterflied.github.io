<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet"> -->
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:600,600i,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet"> 

<link rel="stylesheet" href="/assets/css/tailwind.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/cards.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100&display=swap" rel="stylesheet">
<title>Row-level Permissions in Django Admin</title>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125808593-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125808593-1');
</script>



<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Row-level Permissions in Django Admin | recluze - Nauman (recluze) on Computing, Philosophy and More …</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Row-level Permissions in Django Admin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="So you’ve started working with Django and you love the admin interface that you get for free with your models. You deploy half of your app with the admin interface and are about to release when you figure out that anyone who can modify a model can do anything with it. There is no concept of “ownership” of records!" />
<meta property="og:description" content="So you’ve started working with Django and you love the admin interface that you get for free with your models. You deploy half of your app with the admin interface and are about to release when you figure out that anyone who can modify a model can do anything with it. There is no concept of “ownership” of records!" />
<meta property="og:site_name" content="recluze - Nauman (recluze) on Computing, Philosophy and More …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-12-16T12:07:44+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Row-level Permissions in Django Admin" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Row-level Permissions in Django Admin","dateModified":"2012-12-16T12:07:44+05:00","datePublished":"2012-12-16T12:07:44+05:00","description":"So you’ve started working with Django and you love the admin interface that you get for free with your models. You deploy half of your app with the admin interface and are about to release when you figure out that anyone who can modify a model can do anything with it. There is no concept of “ownership” of records!","url":"/2012/12/16/row-level-permissions-in-django-admin/","mainEntityOfPage":{"@type":"WebPage","@id":"/2012/12/16/row-level-permissions-in-django-admin/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="texture-blue">
    <div class="container"><div class="navbar">
	<ul>
		
		<a href="/"><li  >Home</li></a>
		
		<a href="/about"><li  >About</li></a>
		
		<a href="/learn"><li  >Courses</li></a>
		
	</ul>
</div></div><div class="container">
	<h1>Row-level Permissions in Django Admin</h1>
	<h4 class="post-description"></h4>
	<div class="post-date" style="margin-top:20px">
		Published on Dec 16, 2012
	</div>
	<ul class="post-tags"><li>Django</li><li>python</li><li>Tutorials</li></ul>
</div>
</header>
  <main>
    <div class="container">
      <div class="post-container">
          <p>So you’ve <a href="https://docs.djangoproject.com/en/dev/intro/tutorial01/">started working with Django</a> and you love the admin interface that you get for free with your models. You deploy half of your app with the admin interface and are about to release when you figure out that anyone who can modify a model can do anything with it. There is no concept of “ownership” of records!</p>

<p>Let me give you an example. Let’s say we’re creating a little MIS for the computer science department where each faculty member can put in his courses and record the course execution (what was done per lecture). That would be a nice application. (In fact, it’s available <a href="http://recluze.github.com/fastnu-csd-audit">open source on github</a> and that is what this tutorial is referring to.) However, the issue is that all instructors can access all the course records and there is no way of ensuring that an instructor can modify only the courses that s/he taught. This isn’t easily possible because admin doesn’t not have “row-level permissions”.</p>

<!--more-->

<p>Of course, we can create them by sub-classing some of the Admin classes and modifying a couple of functions. Here’s how:</p>

<p>Let’s assume we have the following in our models:</p>

<p>[sourcecode lang=”python”]<br />
class Instructor(models.Model):<br />
 name = models.CharField(max_length=200)<br />
 # other stuff here</p>

<p>class Course(models.Model):<br />
 course_code = models.CharField(max_length=10, default=’CS’)<br />
 instructor = models.ForeignKey(Instructor)<br />
 course_name = models.CharField(max_length=200)<br />
 # other stuff here</p>

<p>class CourseOutline(models.Model):<br />
 course = models.OneToOneField(Course)<br />
 objectives = models.TextField(blank=True)<br />
 # other stuff<br />
[/sourcecode]</p>

<p>And in admin.py, we have the following:</p>

<p>[sourcecode lang=”python”]<br />
class CourseAdmin(admin.ModelAdmin):<br />
 list_display = (‘course_name’, ‘instructor’)<br />
 # some other stuff</p>

<p>admin.site.register(Course, CourseAdmin)</p>

<p>class CourseOutlineAdmin(admin.ModelAdmin):<br />
 # nothing here of importance</p>

<p>admin.site.register(CourseOutline, CourseOutlineAdmin)<br />
[/sourcecode]</p>

<p>So, when you open the page for Course, you can see the instructors and when you open the CourseOutline, you can see the Courses. Pretty good but how do we add row-level permissions? We do this by overriding a couple of functions.</p>

<p>Here’s the strategy I followed:</p>

<p>First, create a user account for each instructor. Then, take away these user’s rights to modify Instructor objects. (You can keep stuff in Instructor Profile so that they can modify their information.)</p>

<p>Next, add a field to the Instructor model that binds it to a particular user. The model now becomes:</p>

<p>[sourcecode lang=”python”]<br />
from django.contrib.auth.models import User<br />
…</p>

<p>class Instructor(models.Model):<br />
 name = models.CharField(max_length=200)<br />
 owner = models.ForeignKey(User)<br />
 # other stuff here</p>

<p>[/sourcecode]</p>

<p>The other models can remain the same. We only need to modify their “querysets”. Let’s open up admin.py again and modify the *Admins.</p>

<p>We override two functions to make CourseAdmin look like the following:</p>

<p>[sourcecode lang=”python”]<br />
class CourseAdmin(admin.ModelAdmin):<br />
 # whatever was here</p>

<p>def queryset(self, request):<br />
 qs = super(CourseAdmin, self).queryset(request)<br />
 if request.user.is_superuser:<br />
 return qs</p>

<h1 id="get-instructors-owner">get instructor’s “owner”</h1>
<p>return qs.filter(instructor__owner=request.user)</p>

<p>def formfield_for_foreignkey(self, db_field, request, **kwargs):<br />
 if db_field.name == “instructor” and not request.user.is_superuser:<br />
 kwargs[“queryset”] = Instructor.objects.filter(owner=request.user)<br />
 return db_field.formfield(**kwargs)<br />
 return super(CourseAdmin, self).formfield_for_foreignkey(db_field, request, **kwargs)</p>

<p>admin.site.register(Course, CourseAdmin)<br />
[/sourcecode]</p>

<p>What’s that? The first function basically modifies the queryset function and makes sure that if you’re not a super user, you will see only those courses in the course list where <code class="language-plaintext highlighter-rouge">instructor__owner=request.user</code> i.e. your own courses.</p>

<p>The second function is required so that you can’t add courses that belong to other instructors. It filters the foreign key dropdown box so that only <code class="language-plaintext highlighter-rouge">owner=request.user</code> objects are shown in the foreign key dropdown. That is, you only see yourself in that dropdown.</p>

<p>We can do the same thing for CourseOutline. That is here:</p>

<p>[sourcecode lang=”python”]<br />
class CourseOutlineAdmin(admin.ModelAdmin):<br />
 # whatever was here</p>

<p>def queryset(self, request):<br />
 qs = super(CourseOutlineAdmin, self).queryset(request)<br />
 if request.user.is_superuser:<br />
 return qs</p>

<h1 id="get-instructors-owner-1">get instructor’s “owner”</h1>
<p>return qs.filter(course__instructor__owner=request.user)</p>

<p>def formfield_for_foreignkey(self, db_field, request, **kwargs):<br />
 if db_field.name == “course” and not request.user.is_superuser:<br />
 kwargs[“queryset”] = Course.objects.filter(instructor__owner=request.user)<br />
 return db_field.formfield(**kwargs)<br />
 return super(CourseAdmin, self).formfield_for_foreignkey(db_field, request, **kwargs)</p>

<p>[/sourcecode]</p>

<p>The only difference is that we’re now going two levels up the foreign key ladder. That’s all you need to have row-level permissions in admin. Questions?</p>


      </div>

        <!-- Configure Disqus --></div>
  </main><footer class="footer">
  <span class="text-muted"> recluze | No rights reserved.</span>
</footer>
</body>
</html>