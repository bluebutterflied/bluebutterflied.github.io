<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet"> -->
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:600,600i,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet"> 

<link rel="stylesheet" href="/assets/css/tailwind.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/cards.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100&display=swap" rel="stylesheet">
<title>Writing a basic SELinux LPM</title>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125808593-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125808593-1');
</script>



<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Writing a basic SELinux LPM | recluze - Nauman (recluze) on Computing, Philosophy and More …</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Writing a basic SELinux LPM" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I couldn&#39;t find a straight forward tutorial on how to create an LPM in SELinux. So, here goes. Notice that this is for educational purposes only and would only take you so far. You need to study the implications of LPMs and how SELinux works before you can actually use them. Assumptions: You know what SELinux is. You know what types, attributes, macros etc are in SELinux. You have read about Loadable Policy Modules (LPMs) and want to use them. You don&#39;t know how to write and compile/use an LPM. Setup: Set SELinux to permissive. (Not enforcing. This isn&#39;t a complete tutorial!) Get setools package (possibly from yum) Install selinux-policy-devel package (possibly from yum) Operations: (su whenever you need to) Create a directory. I&#39;m assuming /home/user/lpm cd into the directory and create a sample policy. (See below for policy where it will be explained). Let&#39;s call it myapp.te Copy the LPM makefile from /usr/share/selinux/devel. (This comes with selinux-policy-devel) Run &quot;make&quot;  &lt; compiles the .te file Run &quot;semodule -i myapp.pp&quot;&lt; loads the LPM Run &quot;cp /usr/bin/tail ./tt2&quot; &lt; copies the tail script here for testing purposes Run &quot;touch myapplog.log&quot; &lt; create a dummy log file Run &quot;chcon -t myapp_exec_t tt2&quot; &lt; Assign label to executable (see policy for description) Run &quot;chcon -t myapp_log_t myapplog.log&quot;  &lt; Assign label to log file Run &quot;seaudit&quot;. Open log file &quot;/var/log/messages&quot; if you do not have auditd installed or &quot;/var/log/audit/audit.log&quot; if you do. Run &quot;./tt2 myapplog.log&quot; &lt; Run the file. Take a look at the seaudit for auditting details. (See attached screenshots for details) Notice the denies. (tail requires many allows which we haven&#39;t put in the LPM. You can continue to fix these to get rid of all the denies.) The policy: -----------------------|      myapp.te       |---------------------" />
<meta property="og:description" content="I couldn&#39;t find a straight forward tutorial on how to create an LPM in SELinux. So, here goes. Notice that this is for educational purposes only and would only take you so far. You need to study the implications of LPMs and how SELinux works before you can actually use them. Assumptions: You know what SELinux is. You know what types, attributes, macros etc are in SELinux. You have read about Loadable Policy Modules (LPMs) and want to use them. You don&#39;t know how to write and compile/use an LPM. Setup: Set SELinux to permissive. (Not enforcing. This isn&#39;t a complete tutorial!) Get setools package (possibly from yum) Install selinux-policy-devel package (possibly from yum) Operations: (su whenever you need to) Create a directory. I&#39;m assuming /home/user/lpm cd into the directory and create a sample policy. (See below for policy where it will be explained). Let&#39;s call it myapp.te Copy the LPM makefile from /usr/share/selinux/devel. (This comes with selinux-policy-devel) Run &quot;make&quot;  &lt; compiles the .te file Run &quot;semodule -i myapp.pp&quot;&lt; loads the LPM Run &quot;cp /usr/bin/tail ./tt2&quot; &lt; copies the tail script here for testing purposes Run &quot;touch myapplog.log&quot; &lt; create a dummy log file Run &quot;chcon -t myapp_exec_t tt2&quot; &lt; Assign label to executable (see policy for description) Run &quot;chcon -t myapp_log_t myapplog.log&quot;  &lt; Assign label to log file Run &quot;seaudit&quot;. Open log file &quot;/var/log/messages&quot; if you do not have auditd installed or &quot;/var/log/audit/audit.log&quot; if you do. Run &quot;./tt2 myapplog.log&quot; &lt; Run the file. Take a look at the seaudit for auditting details. (See attached screenshots for details) Notice the denies. (tail requires many allows which we haven&#39;t put in the LPM. You can continue to fix these to get rid of all the denies.) The policy: -----------------------|      myapp.te       |---------------------" />
<meta property="og:site_name" content="recluze - Nauman (recluze) on Computing, Philosophy and More …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2008-08-27T07:49:54+06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Writing a basic SELinux LPM" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Writing a basic SELinux LPM","dateModified":"2008-08-27T07:49:54+06:00","datePublished":"2008-08-27T07:49:54+06:00","description":"I couldn&#39;t find a straight forward tutorial on how to create an LPM in SELinux. So, here goes. Notice that this is for educational purposes only and would only take you so far. You need to study the implications of LPMs and how SELinux works before you can actually use them. Assumptions: You know what SELinux is. You know what types, attributes, macros etc are in SELinux. You have read about Loadable Policy Modules (LPMs) and want to use them. You don&#39;t know how to write and compile/use an LPM. Setup: Set SELinux to permissive. (Not enforcing. This isn&#39;t a complete tutorial!) Get setools package (possibly from yum) Install selinux-policy-devel package (possibly from yum) Operations: (su whenever you need to) Create a directory. I&#39;m assuming /home/user/lpm cd into the directory and create a sample policy. (See below for policy where it will be explained). Let&#39;s call it myapp.te Copy the LPM makefile from /usr/share/selinux/devel. (This comes with selinux-policy-devel) Run &quot;make&quot;  &lt; compiles the .te file Run &quot;semodule -i myapp.pp&quot;&lt; loads the LPM Run &quot;cp /usr/bin/tail ./tt2&quot; &lt; copies the tail script here for testing purposes Run &quot;touch myapplog.log&quot; &lt; create a dummy log file Run &quot;chcon -t myapp_exec_t tt2&quot; &lt; Assign label to executable (see policy for description) Run &quot;chcon -t myapp_log_t myapplog.log&quot;  &lt; Assign label to log file Run &quot;seaudit&quot;. Open log file &quot;/var/log/messages&quot; if you do not have auditd installed or &quot;/var/log/audit/audit.log&quot; if you do. Run &quot;./tt2 myapplog.log&quot; &lt; Run the file. Take a look at the seaudit for auditting details. (See attached screenshots for details) Notice the denies. (tail requires many allows which we haven&#39;t put in the LPM. You can continue to fix these to get rid of all the denies.) The policy: -----------------------|      myapp.te       |---------------------","url":"/2008/08/27/writing-a-basic-selinux-lpm/","mainEntityOfPage":{"@type":"WebPage","@id":"/2008/08/27/writing-a-basic-selinux-lpm/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="texture-blue">
    <div class="container"><div class="navbar">
	<ul>
		
		<a href="/"><li  >Home</li></a>
		
		<a href="/about"><li  >About</li></a>
		
		<a href="/learn"><li  >Courses</li></a>
		
	</ul>
</div></div><div class="container">
	<h1>Writing a basic SELinux LPM</h1>
	<h4 class="post-description"></h4>
	<div class="post-date" style="margin-top:20px">
		Published on Aug 27, 2008
	</div>
	<ul class="post-tags"><li>Tutorials</li></ul>
</div>
</header>
  <main>
    <div class="container">
      <div class="post-container">
          <p>I couldn't find a straight forward tutorial on how to create an LPM in SELinux. So, here goes. Notice that this is for educational purposes only and would only take you so far. You need to study the implications of LPMs and how SELinux works before you can actually use them.</p>
<p><strong>Assumptions: </strong></p>
<ol>
<li>You know what SELinux is.</li>
<li>You know what types, attributes, macros etc are in SELinux.</li>
<li>You have read about Loadable Policy Modules (LPMs) and want to use them.</li>
<li>You don't know how to write and compile/use an LPM.</li>
</ol>
<p><strong>Setup:</strong></p>
<ol>
<li>Set SELinux to permissive. (Not enforcing. This isn't a complete tutorial!)</li>
<li>Get <em>setools</em> package (possibly from yum)</li>
<li>Install <em>selinux-policy-devel</em> package (possibly from yum)</li>
</ol>
<p><strong>Operations</strong>: (<em>su</em> whenever you need to)</p>
<ol>
<li>Create a directory. I'm assuming /home/user/lpm</li>
<li>cd into the directory and create a sample policy. (See below for policy where it will be explained). Let's call it <em>myapp.te</em></li>
<li>Copy the LPM makefile from /usr/share/selinux/devel. (This comes with selinux-policy-devel)</li>
<li>Run "make"  &lt; compiles the .te file</li>
<li>Run "semodule -i myapp.pp"&lt; loads the LPM</li>
<li>Run "cp /usr/bin/tail ./tt2" &lt; copies the tail script here for testing purposes</li>
<li>Run "touch myapplog.log" &lt; create a dummy log file</li>
<li>Run "chcon -t myapp_exec_t tt2" &lt; Assign label to executable (see policy for description)</li>
<li>Run "chcon -t myapp_log_t myapplog.log"  &lt; Assign label to log file</li>
<li>Run "seaudit". Open log file "/var/log/messages" if you do not have auditd installed or "/var/log/audit/audit.log" if you do.</li>
<li>Run "./tt2 myapplog.log" &lt; Run the file.</li>
<li>Take a look at the seaudit for auditting details. (See attached screenshots for details)</li>
<li>Notice the denies. (tail requires many allows which we haven't put in the LPM. You can continue to fix these to get rid of all the denies.)</li>
</ol>
<p><strong>The policy:</strong></p>
<pre>-----------------------|      myapp.te       |---------------------

policy_module(myapp,1.0.0)

# Adopted from /usr/share/selinux/devel/example.te

# Declarations

require{
type fs_t;
type unconfined_devpts_t;
}

type myapp_t;
type myapp_exec_t;
domain_type(myapp_t)
# myapp_t is a process (belongs to domain attribute)

domain_entry_file(myapp_t, myapp_exec_t)
# allow myapp_t to be transitioned to using myapp_exec_t

type myapp_log_t;
logging_log_file(myapp_log_t)

type myapp_tmp_t;
files_tmp_file(myapp_tmp_t)

domain_auto_trans(domain, myapp_exec_t, myapp_t)
# transition from 'domain' (any process) to myapp_t through myapp_exec_t executable

#
# Myapp local policy
#
allow myapp_exec_t fs_t:filesystem associate;

allow myapp_t unconfined_devpts_t : chr_file *;
# allow myapp_t access to the terminal

allow domain myapp_exec_t : file {execute read write} ;
# allow any process to run myapp_exec_t

auditallow myapp_t myapp_log_t:file ra_file_perms;
auditallow myapp_t myapp_log_t:file read;
# auditallow myapp_t to read myapp_log_t

allow myapp_t myapp_tmp_t:file manage_file_perms;
files_tmp_filetrans(myapp_t,myapp_tmp_t,file)

-----------------------------------------------------------
 **Screencaps:**

1. SETroubleshoot showing error message (denied access to terminal) [[see here](http://i11.photobucket.com/albums/a181/recluzepb/seaudit1.png)]
2. SEAudit showing log with denies and grants [[see here](http://i11.photobucket.com/albums/a181/recluzepb/seaudit2.png)]

**audit2allow:(updated)**

If you want to generate allow rules automatically, use audit2allow:

audit2allow -i /var/log/audit/audit.log

This will show you the rules which need to be added to the .te file for the whole thing to work.

</pre>

      </div>

        <!-- Configure Disqus --></div>
  </main><footer class="footer">
  <span class="text-muted"> recluze | No rights reserved.</span>
</footer>
</body>
</html>