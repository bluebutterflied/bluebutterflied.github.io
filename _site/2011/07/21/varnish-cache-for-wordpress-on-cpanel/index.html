<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet"> -->
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:600,600i,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet"> 

<link rel="stylesheet" href="/assets/css/tailwind.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/cards.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100&display=swap" rel="stylesheet">
<title>Varnish Cache for Wordpress on cPanel</title>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125808593-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125808593-1');
</script>



<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Varnish Cache for Wordpress on cPanel | recluze - Nauman (recluze) on Computing, Philosophy and More …</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Varnish Cache for Wordpress on cPanel" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Varnish is an extremely easy to configure server cache software that can help you counter the ‘slashdot effect’ – high traffic over a small period of time. The way Varnish does this is by sitting between the client and the webserver and providing cached results to the client so that the server doesn’t have to process every page. It’s better than memcache etc because the request never gets to the webserver. You can avoid one of the bottlenecks this way. In this tutorial, we’ll cover how to setup Varnish on a VPS (or dedicated server) where you have root access and are running your site using cPanel/WHM. It also applies to situations where you don’t have cPanel/WHM. You can just skip the cPanel portion if that’s the case. So, let’s get started." />
<meta property="og:description" content="Varnish is an extremely easy to configure server cache software that can help you counter the ‘slashdot effect’ – high traffic over a small period of time. The way Varnish does this is by sitting between the client and the webserver and providing cached results to the client so that the server doesn’t have to process every page. It’s better than memcache etc because the request never gets to the webserver. You can avoid one of the bottlenecks this way. In this tutorial, we’ll cover how to setup Varnish on a VPS (or dedicated server) where you have root access and are running your site using cPanel/WHM. It also applies to situations where you don’t have cPanel/WHM. You can just skip the cPanel portion if that’s the case. So, let’s get started." />
<meta property="og:site_name" content="recluze - Nauman (recluze) on Computing, Philosophy and More …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-07-21T04:42:10+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Varnish Cache for Wordpress on cPanel" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Varnish Cache for Wordpress on cPanel","dateModified":"2011-07-21T04:42:10+05:00","datePublished":"2011-07-21T04:42:10+05:00","description":"Varnish is an extremely easy to configure server cache software that can help you counter the ‘slashdot effect’ – high traffic over a small period of time. The way Varnish does this is by sitting between the client and the webserver and providing cached results to the client so that the server doesn’t have to process every page. It’s better than memcache etc because the request never gets to the webserver. You can avoid one of the bottlenecks this way. In this tutorial, we’ll cover how to setup Varnish on a VPS (or dedicated server) where you have root access and are running your site using cPanel/WHM. It also applies to situations where you don’t have cPanel/WHM. You can just skip the cPanel portion if that’s the case. So, let’s get started.","url":"/2011/07/21/varnish-cache-for-wordpress-on-cpanel/","mainEntityOfPage":{"@type":"WebPage","@id":"/2011/07/21/varnish-cache-for-wordpress-on-cpanel/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="texture-blue">
    <div class="container"><div class="navbar">
	<ul>
		
		<a href="/"><li  >Home</li></a>
		
		<a href="/about"><li  >About</li></a>
		
		<a href="/learn"><li  >Courses</li></a>
		
	</ul>
</div></div><div class="container">
	<h1>Varnish Cache for Wordpress on cPanel</h1>
	<h4 class="post-description"></h4>
	<div class="post-date" style="margin-top:20px">
		Published on Jul 21, 2011
	</div>
	<ul class="post-tags"><li>Linux</li><li>resources</li><li>Tutorials</li></ul>
</div>
</header>
  <main>
    <div class="container">
      <div class="post-container">
          <p>Varnish is an extremely easy to configure server cache software that can help you counter the ‘slashdot effect’ – high traffic over a small period of time. The way Varnish does this is by sitting between the client and the webserver and providing cached results to the client so that the server doesn’t have to process every page. It’s better than memcache etc because the request never gets to the webserver. You can avoid one of the bottlenecks this way. In this tutorial, we’ll cover how to setup Varnish on a VPS (or dedicated server) where you have root access and are running your site using cPanel/WHM. It also applies to situations where you don’t have cPanel/WHM. You can just skip the cPanel portion if that’s the case. So, let’s get started.</p>

<!--more-->
<p>First, you need to get Varnish. It’s very easy to setup since it comes with its own repository for CentOS. It does have on dependency that’s normally missing. That dependency is jemalloc.so. When you try to install varnish, it gives the error:</p>

<p>Missing Dependency: libjemalloc.so.1()(64bit) is needed by package varnish-3.0.0-1.el5.x86_64 (varnish-3.0)</p>

<p>Get this file and install it using the following commands:</p>

<p><code class="language-plaintext highlighter-rouge">wget http://download.fedora.redhat.com/pub/epel/5/x86_64/jemalloc-2.1.3-2.el5.x86_64.rpm</code><br />
<code class="language-plaintext highlighter-rouge">rpm -ivh jemalloc-2.1.3-2.el5.x86_64.rpm</code></p>

<p>Now we have the dependency. Head over to <a href="https://www.varnish-cache.org/docs">Varnish Docs page</a> and read the instructions for your operating system. Since I’m describing CentOS, here are the instructions for that:</p>

<p><code class="language-plaintext highlighter-rouge">rpm --nosignature -i http://repo.varnish-cache.org/redhat/varnish-3.0/el5/noarch/varnish-release-3.0-1.noarch.rpm</code></p>

<p><code class="language-plaintext highlighter-rouge">yum install varnish</code></p>

<p>Now to edit the varnish configuration file. It’s located at: <code class="language-plaintext highlighter-rouge">etc/varnish/default.vcl</code>. Insert the following code in the file. Explanation of the different constructs follows:</p>

<p>[sourcecode]<br />
backend default {<br />
 .host = “your.primary.domainname.com”;<br />
 .port = “80”;<br />
}<br />
sub vcl_recv {<br />
 if (req.http.Accept-Encoding) {<br />
 if (req.url ~ “.(jpg|png|gif|gz|tgz|bz2|lzma|tbz)(?.*|)$”) {<br />
 remove req.http.Accept-Encoding;<br />
 } elsif (req.http.Accept-Encoding ~ “gzip”) {<br />
 set req.http.Accept-Encoding = “gzip”;<br />
 } elsif (req.http.Accept-Encoding ~ “deflate”) {<br />
 set req.http.Accept-Encoding = “deflate”;<br />
 } else {<br />
 remove req.http.Accept-Encoding;<br />
 }<br />
 }<br />
 if (req.url ~ “^/[^?]+.(jpeg|jpg|png|gif|ico|js|css|txt|gz|zip|lzma|bz2|tgz|tbz|html|htm)(?.*|)$”) {<br />
 unset req.http.cookie;<br />
 }<br />
 if (req.request == “GET” &amp;&amp; req.url ~ “cron_job” ||         req.url ~ “something_else”        ) {<br />
 return ( pass );<br />
 }<br />
}<br />
[/sourcecode]</p>

<p>The configuration file is fairly straight forward. Just a couple of things that need explanation. Backend defines your webserver. You can have multiple backends and load balance between them but I’m not covering that here. Read up on varnish docs for that.</p>

<p>The sub vcl_recv portion gets called before a request gets passed to the backend or gets checked in the cache. You can define different rules here. For example, the rule <code class="language-plaintext highlighter-rouge">if (req.url ~ "^/[^?]+.(jpeg| ... </code> says that if the requested URL matches one of those extensions, the http cookie should be unset. This is important because if a cookie is present in any request, varnish will always bypass the cache and send the request to the webserver. By unsetting the cookie, you’re giving varnish a chance to check if a cache hit will occur.</p>

<p>The second important line here is the <code class="language-plaintext highlighter-rouge">return(pass); </code> directive. Whenever this gets called, the cache is ignored again and the request is passed through to the webserver. In our case, if the request URL contains either the word ‘cron_job’ or ‘something_else’, it gets ignored by varnish. You might want to do this if (as in this case), there’s a cron job that does not have a cookie but still needs to be called on the webserver each time.</p>

<p>Ok, enough talk. Let’s start varnish. Here’s the command:</p>

<p><code class="language-plaintext highlighter-rouge">varnishd -f /etc/varnish/default.vcl -s malloc,1G -T 127.0.0.1:2000 -a 0.0.0.0:8080</code></p>

<p>It reads the configuration file given by the <code class="language-plaintext highlighter-rouge">-f</code> directive, allocates 1GB memory to varnish, sets up an admin interface on port 2000 and sets up the varnish listening port on 8080. Notice that we currently have varnish set on 8080 and the webserver on 80. This is so that we can test varnish without disrupting the normal processing of the server. After we’re done testing, we’ll change the webserver to 8080 and varnish to 80.</p>

<p>To see the status of varnish request processing, run <code class="language-plaintext highlighter-rouge">varnishtop</code> on the shell and send a request to your server on port 8080.</p>

<p>To configure a running instance of varnish, you can use the <code class="language-plaintext highlighter-rouge">varnishadm</code> command. For example, run <code class="language-plaintext highlighter-rouge">varnishadm</code> and issue the following commands to reload the configuration file (after you’ve made some changes to it).</p>

<p><code class="language-plaintext highlighter-rouge">help</code><br />
<code class="language-plaintext highlighter-rouge">vcl.load reload01 /etc/varnish/default.vcl</code><br />
<code class="language-plaintext highlighter-rouge">vcl.use reload01</code></p>

<p>Finally, when you have everything ready, it’s time to kill varnish, change the server port to 8080 and re-run varnish on port 80. First,</p>

<p><code class="language-plaintext highlighter-rouge">killall varnishd</code></p>

<p>Edit the configuration file and change backend port to 8080 instead of 80.</p>

<p><strong>cPanel/WHM configuration</strong></p>

<p>This one’s easy. If you’re just using apache, change all listening ports to 8080 and change your vhost directives. If you’re using cPanel/WHM, go to WHM -&gt; Tweak Settings and change “Apache non-SSL IP/port” to “0.0.0.0:8080”. (If you have apache listening on a specific IP, you can change the 0s accordingly).</p>

<p>Now, save, restart apache and issue the following command to start varnish:</p>

<p><code class="language-plaintext highlighter-rouge">varnishd -f /etc/varnish/default.vcl -s malloc,1G -T 127.0.0.1:2000 -a 0.0.0.0:80</code></p>

<p>You should now be able to browse the site and check varnishtop to see that varnish is processing the requests. You might also want to put the command (prefixing it with /usr/bin/varnishd instead of varnishd) in /etc/rc.local so that varnish starts on reboot.</p>


      </div>

        <!-- Configure Disqus --></div>
  </main><footer class="footer">
  <span class="text-muted"> recluze | No rights reserved.</span>
</footer>
</body>
</html>