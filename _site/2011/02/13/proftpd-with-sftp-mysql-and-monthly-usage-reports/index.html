<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet"> -->
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:600,600i,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet"> 

<link rel="stylesheet" href="/assets/css/tailwind.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/cards.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100&display=swap" rel="stylesheet">
<title>ProFTPD with SFTP, MySQL and Monthly Usage Reports</title>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125808593-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125808593-1');
</script>



<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>ProFTPD with SFTP, MySQL and Monthly Usage Reports | recluze - Nauman (recluze) on Computing, Philosophy and More …</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="ProFTPD with SFTP, MySQL and Monthly Usage Reports" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="To install ProFTPD with MySQL-based authentication and SFTP support, you need to download the latest version of the source code and build it with customized options. But first, some prerequisites. (These instructions are for ubuntu but can easily be modified for CentOS)." />
<meta property="og:description" content="To install ProFTPD with MySQL-based authentication and SFTP support, you need to download the latest version of the source code and build it with customized options. But first, some prerequisites. (These instructions are for ubuntu but can easily be modified for CentOS)." />
<meta property="og:site_name" content="recluze - Nauman (recluze) on Computing, Philosophy and More …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-02-13T03:49:41+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ProFTPD with SFTP, MySQL and Monthly Usage Reports" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"ProFTPD with SFTP, MySQL and Monthly Usage Reports","dateModified":"2011-02-13T03:49:41+05:00","datePublished":"2011-02-13T03:49:41+05:00","description":"To install ProFTPD with MySQL-based authentication and SFTP support, you need to download the latest version of the source code and build it with customized options. But first, some prerequisites. (These instructions are for ubuntu but can easily be modified for CentOS).","url":"/2011/02/13/proftpd-with-sftp-mysql-and-monthly-usage-reports/","mainEntityOfPage":{"@type":"WebPage","@id":"/2011/02/13/proftpd-with-sftp-mysql-and-monthly-usage-reports/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="texture-blue">
    <div class="container"><div class="navbar">
	<ul>
		
		<a href="/"><li  >Home</li></a>
		
		<a href="/about"><li  >About</li></a>
		
		<a href="/learn"><li  >Courses</li></a>
		
	</ul>
</div></div><div class="container">
	<h1>ProFTPD with SFTP, MySQL and Monthly Usage Reports</h1>
	<h4 class="post-description"></h4>
	<div class="post-date" style="margin-top:20px">
		Published on Feb 13, 2011
	</div>
	<ul class="post-tags"><li>Tutorials</li><li>Web</li></ul>
</div>
</header>
  <main>
    <div class="container">
      <div class="post-container">
          <p>To install ProFTPD with MySQL-based authentication and SFTP support, you need to download the latest version of the source code and build it with customized options. But first, some prerequisites. (These instructions are for ubuntu but can easily be modified for CentOS).<br />
<!--more--></p>

<p>Download the dependencies:</p>

<p>[sourcecode lang=”bash”]<br />
apt-get install mysql mysql-server mysql-client libmysql++-dev libssl-dev build-essential libncurses-dev<br />
[/sourcecode]</p>

<p>Setup the ftpgroup and ftpuser which will own all the files on the server. The virtual MySQL users will be mapped to these two:</p>

<p>[sourcecode lang=”bash”]<br />
groupadd -g 2001 ftpgroup<br />
useradd -u 2001 -s /sbin/false -d /bin/null -c “proftpd user” -g ftpgroup ftpuser<br />
[/sourcecode]</p>

<p>Create mysql database structure required by proftpd</p>

<p>[sourcecode lang=”sql”]<br />
/etc/init.d/mysqld start<br />
mysqladmin -root -p password ‘yourpassword’<br />
mysql -uroot -p</p>

<p>CREATE DATABASE ftp;<br />
USE ftp;</p>

<p>CREATE TABLE ftpgroup (<br />
groupname varchar(16) NOT NULL default ‘’,<br />
gid smallint(6) NOT NULL default ‘5500’,<br />
members varchar(16) NOT NULL default ‘’,<br />
KEY groupname (groupname)<br />
) TYPE=MyISAM COMMENT=’ProFTP group table’;</p>

<p>CREATE TABLE ftpquotalimits (<br />
name varchar(30) default NULL,<br />
quota_type enum(‘user’,’group’,’class’,’all’) NOT NULL default ‘user’,<br />
per_session enum(‘false’,’true’) NOT NULL default ‘false’,<br />
limit_type enum(‘soft’,’hard’) NOT NULL default ‘soft’,<br />
bytes_in_avail int(10) unsigned NOT NULL default ‘0’,<br />
bytes_out_avail int(10) unsigned NOT NULL default ‘0’,<br />
bytes_xfer_avail int(10) unsigned NOT NULL default ‘0’,<br />
files_in_avail int(10) unsigned NOT NULL default ‘0’,<br />
files_out_avail int(10) unsigned NOT NULL default ‘0’,<br />
files_xfer_avail int(10) unsigned NOT NULL default ‘0’<br />
) TYPE=MyISAM;</p>

<p>CREATE TABLE ftpquotatallies (<br />
name varchar(30) NOT NULL default ‘’,<br />
quota_type enum(‘user’,’group’,’class’,’all’) NOT NULL default ‘user’,<br />
bytes_in_used int(10) unsigned NOT NULL default ‘0’,<br />
bytes_out_used int(10) unsigned NOT NULL default ‘0’,<br />
bytes_xfer_used int(10) unsigned NOT NULL default ‘0’,<br />
files_in_used int(10) unsigned NOT NULL default ‘0’,<br />
files_out_used int(10) unsigned NOT NULL default ‘0’,<br />
files_xfer_used int(10) unsigned NOT NULL default ‘0’<br />
) TYPE=MyISAM;</p>

<p>CREATE TABLE ftpuser (<br />
id int(10) unsigned NOT NULL auto_increment,<br />
userid varchar(32) NOT NULL default ‘’,<br />
passwd varchar(32) NOT NULL default ‘’,<br />
uid smallint(6) NOT NULL default ‘5500’,<br />
gid smallint(6) NOT NULL default ‘5500’,<br />
homedir varchar(255) NOT NULL default ‘’,<br />
shell varchar(16) NOT NULL default ‘/sbin/nologin’,<br />
count int(11) NOT NULL default ‘0’,<br />
accessed datetime NOT NULL default ‘0000-00-00 00:00:00’,<br />
modified datetime NOT NULL default ‘0000-00-00 00:00:00’,<br />
PRIMARY KEY (id),<br />
UNIQUE KEY userid (userid)<br />
) TYPE=MyISAM COMMENT=’ProFTP user table’;</p>

<p>CREATE TABLE IF NOT EXISTS <code class="language-plaintext highlighter-rouge">xferlog</code> (<br />
 <code class="language-plaintext highlighter-rouge">username</code> varchar(100) NOT NULL,<br />
 <code class="language-plaintext highlighter-rouge">timestamp</code> datetime NOT NULL,<br />
 <code class="language-plaintext highlighter-rouge">bytes</code> int(20) NOT NULL,<br />
 <code class="language-plaintext highlighter-rouge">file</code> varchar(255) NOT NULL,<br />
 <code class="language-plaintext highlighter-rouge">direction</code> varchar(1) NOT NULL,<br />
 <code class="language-plaintext highlighter-rouge">ip</code> varchar(20) NOT NULL,<br />
 KEY <code class="language-plaintext highlighter-rouge">username</code> (<code class="language-plaintext highlighter-rouge">username</code>)<br />
) ENGINE=MyISAM DEFAULT CHARSET=latin1;</p>

<p>GRANT ALL PRIVILEGES ON FTP.* to proftpd@localhost identified by ‘yourpassword’;</p>

<p>INSERT INTO <code class="language-plaintext highlighter-rouge">ftpgroup</code> (<code class="language-plaintext highlighter-rouge">groupname</code>, <code class="language-plaintext highlighter-rouge">gid</code>, <code class="language-plaintext highlighter-rouge">members</code>) VALUES (‘ftpgroup’, 2001, ‘ftpuser’);<br />
INSERT INTO <code class="language-plaintext highlighter-rouge">ftpuser</code> (<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">userid</code>, <code class="language-plaintext highlighter-rouge">passwd</code>, <code class="language-plaintext highlighter-rouge">uid</code>, <code class="language-plaintext highlighter-rouge">gid</code>, <code class="language-plaintext highlighter-rouge">homedir</code>, <code class="language-plaintext highlighter-rouge">shell</code>, <code class="language-plaintext highlighter-rouge">count</code>, <code class="language-plaintext highlighter-rouge">accessed</code>, <code class="language-plaintext highlighter-rouge">modified</code>) VALUES (1, ‘exampleuser’, ‘secret’, 2001, 2001, ‘/home/www.example.com’, ‘/sbin/nologin’, 0, ‘’, ‘’);</p>

<p>quit;<br />
[/sourcecode]</p>

<p>Download, compile and install proftpd</p>

<p>[sourcecode lang=”bash”]<br />
wget ftp://ftp1.at.proftpd.org/ProFTPD/distrib/source/proftpd-1.3.3c.tar.bz2<br />
tar jxf proftpd-1.3.3c.tar.bz2<br />
cd proftpd-1.3.3c<br />
install_user=root install_group=root ./configure –with-modules=mod_sql:mod_sql_mysql:mod_quotatab:mod_quotatab_sql:mod_sftp –with-includes=/usr/include/mysql/ –with-libraries=/usr/lib/mysql/ –enable-timeout-linger –enable-timeout-stalled –sysconfdir=/etc –localstatedir=/var –prefix=/usr<br />
make &amp;&amp; make install<br />
[/sourcecode]</p>

<p>Create the init scripts for proftpd in <code class="language-plaintext highlighter-rouge">/etc/ini.d/proftpd</code> if it doesn’t already exist.</p>

<p>[sourcecode lang=”bash”]<br />
#!/bin/sh</p>

<h3 id="begin-init-info">BEGIN INIT INFO</h3>
<h1 id="provides-proftpd">Provides: proftpd</h1>
<h1 id="required-start-syslog-local_fs-network">Required-Start: $syslog $local_fs $network</h1>
<h1 id="required-stop-syslog-local_fs-network">Required-Stop: $syslog $local_fs $network</h1>
<h1 id="should-start-remote_fs-named">Should-Start: $remote_fs $named</h1>
<h1 id="should-stop-remote_fs-named">Should-Stop: $remote_fs $named</h1>
<h1 id="default-start-2-3-4-5">Default-Start: 2 3 4 5</h1>
<h1 id="default-stop-0-1-6">Default-Stop: 0 1 6</h1>
<h1 id="short-description-starts-proftpd-daemon">Short-Description: Starts ProFTPD daemon</h1>
<h1 id="description-this-script-runs-the-ftp-service-offered">Description: This script runs the FTP service offered</h1>
<h1 id="by-the-proftpd-daemon">by the ProFTPD daemon</h1>
<h3 id="end-init-info">END INIT INFO</h3>

<h1 id="start-the-proftpd-ftp-daemon">Start the proftpd FTP daemon.</h1>

<p>PATH=/bin:/usr/bin:/sbin:/usr/sbin<br />
DAEMON=/usr/sbin/proftpd<br />
NAME=proftpd</p>

<h1 id="defaults">Defaults</h1>
<p>RUN=”no”<br />
OPTIONS=””</p>

<p>PIDFILE=<code class="language-plaintext highlighter-rouge">grep -i 'pidfile' /etc/proftpd/proftpd.conf | sed -e 's/pidfile[t]+//i'</code><br />
if [“x$PIDFILE” = “x”];<br />
then<br />
 PIDFILE=/var/run/proftpd.pid<br />
fi</p>

<h1 id="read-config-will-override-defaults">Read config (will override defaults)</h1>
<p>[-r /etc/default/proftpd] &amp;&amp; . /etc/default/proftpd</p>

<p>trap “” 1<br />
trap “” 15</p>

<table>
  <tbody>
    <tr>
      <td>test -f $DAEMON</td>
      <td> </td>
      <td>exit 0</td>
    </tr>
  </tbody>
</table>

<p>. /lib/lsb/init-functions</p>

<p>#</p>
<h1 id="servertype-could-be-inetdstandalonenone">Servertype could be inetd|standalone|none.</h1>
<h1 id="in-all-cases-check-against-inetd-and-xinetd-support">In all cases check against inetd and xinetd support.</h1>
<p>#<br />
if ! egrep -qi “^[[:space:]]*ServerType.*standalone” /etc/proftpd/proftpd.conf<br />
then<br />
 if [$(dpkg-divert –list xinetd|wc -l) -eq 1]<br />
 then<br />
 if egrep -qi “server[[:space:]]*=[[:space:]]*/usr/sbin/proftpd” /etc/xinetd.conf 2&gt;/dev/null ||<br />
 egrep -qi “server[[:space:]]*=[[:space:]]*/usr/sbin/proftpd” /etc/xinetd.d/* 2&gt;/dev/null<br />
 then<br />
 RUN=”no”<br />
 INETD=”yes”<br />
 else<br />
 if ! egrep -qi “^[[:space:]]*ServerType.*inetd” /etc/proftpd/proftpd.conf<br />
 then<br />
 RUN=”yes”<br />
 INETD=”no”<br />
 else<br />
 RUN=”no”<br />
 INETD=”no”<br />
 fi<br />
 fi<br />
 else<br />
 if egrep -qi “^ftp.*/usr/sbin/proftpd” /etc/inetd.conf 2&gt;/dev/null<br />
 then<br />
 RUN=”no”<br />
 INETD=”yes”<br />
 else<br />
 if ! egrep -qi “^[[:space:]]*ServerType.*inetd” /etc/proftpd/proftpd.conf<br />
 then<br />
 RUN=”yes”<br />
 INETD=”no”<br />
 else<br />
 RUN=”no”<br />
 INETD=”no”<br />
 fi<br />
 fi<br />
 fi<br />
fi</p>

<h1 id="varrun-could-be-on-a-tmpfs">/var/run could be on a tmpfs</h1>

<p>[! -d /var/run/proftpd] &amp;&amp; mkdir /var/run/proftpd</p>

<p>start()<br />
{<br />
 log_daemon_msg “Starting ftp server” “$NAME”</p>

<p>start-stop-daemon –start –quiet –pidfile “$PIDFILE” –oknodo –exec $DAEMON – $OPTIONS<br />
 if [$? != 0]; then<br />
 log_end_msg 1<br />
 exit 1<br />
 else<br />
 log_end_msg 0<br />
 fi<br />
}</p>

<p>signal()<br />
{</p>

<p>if [“$1” = “stop”]; then<br />
 SIGNAL=”TERM”<br />
 log_daemon_msg “Stopping ftp server” “$NAME”<br />
 else<br />
 if [“$1” = “reload”]; then<br />
 SIGNAL=”HUP”<br />
 log_daemon_msg “Reloading ftp server” “$NAME”<br />
 else<br />
 echo “ERR: wrong parameter given to signal()”<br />
 exit 1<br />
 fi<br />
 fi<br />
 if [-f “$PIDFILE”]; then<br />
 start-stop-daemon –stop –signal $SIGNAL –quiet –pidfile “$PIDFILE”<br />
 if [$? = 0]; then<br />
 log_end_msg 0<br />
 else<br />
 SIGNAL=”KILL”<br />
 start-stop-daemon –stop –signal $SIGNAL –quiet –pidfile “$PIDFILE”<br />
 if [$? != 0]; then<br />
 log_end_msg 1<br />
 [$2 != 0] || exit 0<br />
 else<br />
 log_end_msg 0<br />
 fi<br />
 fi<br />
 if [“$SIGNAL” = “KILL”]; then<br />
 rm -f “$PIDFILE”<br />
 fi<br />
 else<br />
 log_end_msg 0<br />
 fi<br />
}</p>

<p>case “$1” in<br />
 start)<br />
 if [“x$RUN” = “xyes”] ; then<br />
 start<br />
 else<br />
 if [“x$INETD” = “xyes”] ; then<br />
 echo “ProFTPd is started from inetd/xinetd.”<br />
 else<br />
 echo “ProFTPd warning: cannot start neither in standalone nor in inetd/xinetd mode. Check your configuration.”<br />
 fi<br />
 fi<br />
 ;;</p>

<p>force-start)<br />
 if [“x$INETD” = “xyes”] ; then<br />
 echo “Warning: ProFTPd is started from inetd/xinetd (trying to start anyway).”<br />
 fi<br />
 start<br />
 ;;</p>

<p>stop)<br />
 if [“x$RUN” = “xyes”] ; then<br />
 signal stop 0<br />
 else<br />
 if [“x$INETD” = “xyes”] ; then<br />
 echo “ProFTPd is started from inetd/xinetd.”<br />
 else<br />
 echo “ProFTPd warning: cannot start neither in standalone nor in inetd/xinetd mode. Check your configuration.”<br />
 fi<br />
 fi<br />
 ;;</p>

<p>force-stop)<br />
 if [“x$INETD” = “xyes”] ; then<br />
 echo “Warning: ProFTPd is started from inetd/xinetd (trying to kill anyway).”<br />
 fi<br />
 signal stop 0<br />
 ;;</p>

<p>reload)<br />
 signal reload 0<br />
 ;;</p>

<p>force-reload|restart)<br />
 if [“x$RUN” = “xyes”] ; then<br />
 signal stop 1<br />
 sleep 2<br />
 start<br />
 else<br />
 if [“x$INETD” = “xyes”] ; then<br />
 echo “ProFTPd is started from inetd/xinetd.”<br />
 else<br />
 echo “ProFTPd warning: cannot start neither in standalone nor in inetd/xinetd mode. Check your configuration.”<br />
 fi<br />
 fi<br />
 ;;</p>

<p>status)<br />
 if [“x$INETD” = “xyes”] ; then<br />
 echo “ProFTPd is started from inetd/xinetd.”<br />
 exit 0<br />
 else<br />
 if [-f “$PIDFILE”]; then<br />
 pid=$(cat $PIDFILE)<br />
 else<br />
 pid=”x”<br />
 fi<br />
 if [<code class="language-plaintext highlighter-rouge">pidof proftpd|grep "$pid"|wc -l</code> -ne 0] ; then<br />
 echo “ProFTPd is started in standalone mode, currently running.”<br />
 exit 0<br />
 else<br />
 echo “ProFTPd is started in standalone mode, currently not running.”<br />
 exit 3<br />
 fi<br />
 fi<br />
 ;;</p>

<p>check-config)<br />
 $DAEMON -t &gt;/dev/null &amp;&amp; echo “ProFTPd configuration OK” &amp;&amp; exit 0<br />
 exit 1<br />
 ;;</p>

<p>*)<br />
 echo “Usage: /etc/init.d/$NAME {start|status|force-start|stop|force-stop|reload|restart|force-reload|check-config}”<br />
 exit 1<br />
 ;;<br />
esac</p>

<p>exit 0<br />
[/sourcecode]</p>

<p>Create the server keys for use with SFTP</p>

<p>[sourcecode lang=”bash”]<br />
ssh-keygen -t rsa<br />
ssh-keygen -t dsa<br />
[/sourcecode]</p>

<p>Edit <code class="language-plaintext highlighter-rouge">/etc/proftpd/proftpd.conf</code> and append the following to the end:</p>

<p>[sourcecode lang=”bash”]<br />
SFTPEngine on # use SFTP instead of FTP<br />
Port 2222<br />
SFTPHostKey /root/.ssh/id_rsa<br />
SFTPHostKey /root/.ssh/id_dsa</p>

<p>DefaultRoot ~ # Jail the FTP users to within their homedir<br />
SQLAuthTypes Plaintext Crypt<br />
SQLAuthenticate users* groups*</p>

<h1 id="connection-string-in-the-format-databasehost-user-password">Connection string in the format database@host user password</h1>
<p>SQLConnectInfo ftp@localhost root yourpassword<br />
SQLUserInfo ftpuser userid passwd uid gid homedir shell<br />
SQLGroupInfo ftpgroup groupname gid members<br />
SQLMinID 500<br />
CreateHome on</p>

<p>SQLLog PASS updatecount<br />
SQLNamedQuery updatecount UPDATE “count=count+1, accessed=now() WHERE userid=’%u’” ftpuser<br />
SQLLog STOR,DELE modified<br />
SQLNamedQuery modified UPDATE “modified=now() WHERE userid=’%u’” ftpuser</p>

<p>RootLogin off<br />
RequireValidShell off</p>

<h1 id="important-required-for-bandwidth-accounting">IMPORTANT: required for bandwidth accounting</h1>
<p>TransferLog /var/log/proftpd/xferlog<br />
SystemLog /var/log/proftpd/proftpd.log<br />
[/sourcecode]</p>

<p>Enable the required modules by uncommenting the following lines in <code class="language-plaintext highlighter-rouge">/etc/proftpd/modules.conf</code>.</p>

<p>[sourcecode lang=”bash”]<br />
LoadModule mod_sql.c<br />
LoadModule mod_sql_mysql.c<br />
[/sourcecode]</p>

<p>Start the proftpd server and test it out by connecting to it through your FTP client. In this example, the username is <code class="language-plaintext highlighter-rouge">exampleuser</code> and password is <code class="language-plaintext highlighter-rouge">secret</code>.</p>

<p>[sourcecode lang=”bash”]<br />
/etc/init.d/proftpd start<br />
[/sourcecode]</p>

<p>For the monthly bandwidth accounting report, you need to enable logrotate and call it through cron. First, setup the database configurations and helper functions. This will be <code class="language-plaintext highlighter-rouge">/usr/src/ftpan/config.php</code>:</p>

<p>[sourcecode lang=”php”]<br />
// Database credentials<br />
$db_host = “localhost”;<br />
$db_user = “username”;<br />
$db_pass = “yourpassword”;<br />
$db_sele = “ftp”;<br />
$db_table = “xferlog”;<br />
$db_user_table = “ftpuser”;<br />
$TO_EMAIL = “admin@email.address.com”;</p>

<p>function log_error($str){<br />
 return;<br />
}<br />
function str_log($str){<br />
 global $verbose;<br />
 if($verbose &gt; 0)<br />
 echo $str . “n”;<br />
}<br />
function byte_size($bytes){<br />
 $size = $bytes / 1024;<br />
 if($size &lt; 1024)<br />
 {<br />
 $size = number_format($size, 2);<br />
 $size .= ‘ KB’;<br />
 }<br />
 else<br />
 {<br />
 if($size / 1024 &lt; 1024)<br />
 {<br />
 $size = number_format($size / 1024, 2);<br />
 $size .= ‘ MB’;<br />
 }<br />
 else if ($size / 1024 / 1024 &lt; 1024)<br />
 {<br />
 $size = number_format($size / 1024 / 1024, 2);<br />
 $size .= ‘ GB’;<br />
 }<br />
 }<br />
 return $size;<br />
 }<br />
?&gt;<br />
[/sourcecode]</p>

<p>Then, create a script that will read a transfer log file and populate the database: <code class="language-plaintext highlighter-rouge">/usr/src/ftpan/analyze-proftpd.php</code>.</p>

<p>[sourcecode lang=”php”]<br />
&lt;?php<br />
require_once(‘config.php’);<br />
$verbose = 1;</p>

<p>// get the file name<br />
$logfile = $argv[1];<br />
str_log(“Processing log file: $logfile =================================================== “);<br />
/// connect to the db<br />
mysql_connect($db_host, $db_user, $db_pass);<br />
@mysql_select_db($db_sele) or die( “Unable to access database”);</p>

<p>// open the logfile and process it line by line<br />
$fp = fopen($logfile, ‘r’);<br />
while ( ($inline = fgets($fp)) !== false) {<br />
 // process the file and insert all logs<br />
 $inline = trim($inline);</p>

<p>$tok = strtok($inline, “ “);<br />
 $weekday = $tok; $tok = strtok(“ “);<br />
 $month = $tok; $tok = strtok(“ “);<br />
 $day = $tok; $tok = strtok(“ “);<br />
 $timestamp = $tok; $tok = strtok(“ “);<br />
 $year = $tok; $tok = strtok(“ “);<br />
 $skip = $tok; $tok = strtok(“ “);<br />
 $ip = $tok; $tok = strtok(“ “);<br />
 $bytes = $tok; $tok = strtok(“ “);<br />
 $file = $tok; $tok = strtok(“ “);<br />
 $skip = $tok; $tok = strtok(“ “);<br />
 $skip = $tok; $tok = strtok(“ “);<br />
 $direction = $tok; $tok = strtok(“ “);<br />
 $skip = $tok; $tok = strtok(“ “);<br />
 $user= $tok; $tok = strtok(“ “);</p>

<p>$str_stamp = “$month $day $year $timestamp”;<br />
 $stamp = date(‘Y-m-d H:i:s’, strtotime($str_stamp));</p>

<p>str_log(“Retrieved data: $user $stamp $bytes $file $direction $ip”);</p>

<p>// select to make sure this exact record has not already been entered. (Just in case)<br />
 $query = “select * from $db_table where username = ‘$user’ AND timestamp=’$stamp’ AND bytes=’$bytes’ AND direction=’$direction’ AND ip=’$ip’;”;<br />
 $result = mysql_query($query);</p>

<p>if(mysql_num_rows($result) &gt; 0){<br />
 str_log(“Log entry at stamp $stamp for user $user already exists. Skipping.”);<br />
 continue;<br />
 }</p>

<p>// if not, insert it<br />
 $query = “INSERT into $db_table (username, timestamp, bytes, file, direction, ip)<br />
 VALUES (‘$user’, ‘$stamp’, ‘$bytes’, ‘$file’, ‘$direction’, ‘$ip’); “;</p>

<p>$result = mysql_query($query);<br />
 echo mysql_error();</p>

<p>if($result &lt; 1)<br />
 str_log(“error inserting query: $user $stamp”);</p>

<p>}<br />
// (manually) call the generate CSV for the generation of CSV reports<br />
?&gt;<br />
[/sourcecode]</p>

<p>Finally, create a CSV generation script that will get data from the database and send it through email as well as saving it in the folder. We call it <code class="language-plaintext highlighter-rouge">/usr/src/ftpan/generate-csv.php</code>.</p>

<p>[sourcecode lang=”php”]<br />
&lt;?php<br />
require_once(‘config.php’);<br />
$verbose = 1;</p>

<p>// select the data into a CSV and write to the file named as this stamp;<br />
$date_now = date(‘Y-m-d’);<br />
$this_month = date(‘m’);<br />
$this_year = date(‘Y’);<br />
// make sure this is changed to LAST month instead of this month when deploying : done<br />
$date_begin = date(‘Y-m-d H:i:s’, mktime(0, 0, 0, $this_month -1, 1, $this_year));<br />
$date_end = date(‘Y-m-d H:i:s’, mktime(11, 59, 59, $this_month, 0, $this_year));</p>

<p>str_log(“Processing on date: $date_now =======================================================”);<br />
str_log($date_begin);<br />
str_log($date_end);</p>

<p>$OUTFILE = “proftpd-usage-report-“ . $date_now . “.csv”;</p>

<p>$fo = fopen($OUTFILE, “w”);</p>

<p>mysql_connect($db_host, $db_user, $db_pass);<br />
@mysql_select_db($db_sele) or die( “Unable to access database”);</p>

<p>// find the distinct usernames from the table<br />
$query = “select userid, homedir from $db_user_table;”;<br />
$result = mysql_query($query);</p>

<p>while($row = mysql_fetch_array($result)){<br />
 // for each user<br />
 $username = $row[‘userid’];<br />
 $homedir = $row[‘homedir’];</p>

<p>str_log(“Finding totals for $username”);</p>

<p>// select the total “in” in this month<br />
 $query2 = “select sum(bytes) from $db_table where username = ‘$username’<br />
 AND direction = ‘i’<br />
 AND timestamp &gt;= ‘$date_begin’ AND timestamp &lt;= ‘$date_end’;”;<br />
 str_log($query2);<br />
 $result2 = mysql_query($query2);</p>

<p>$row2 = mysql_fetch_array($result2);<br />
 $in_total = intval($row2[0]);<br />
 str_log(“In total was: $in_total”);</p>

<p>// select the total “out” in this month<br />
 $query2 = “select sum(bytes) from $db_table where username = ‘$username’<br />
 AND direction = ‘o’<br />
 AND timestamp &gt;= ‘$date_begin’ AND timestamp &lt;= ‘$date_end’;”;<br />
 $result2 = mysql_query($query2);</p>

<p>$row2 = mysql_fetch_array($result2);<br />
 $out_total = intval($row2[0]);<br />
 str_log(“In total was: $out_total”);</p>

<p>// set the total<br />
 $grand_total = byte_size($in_total + $out_total);<br />
 str_log(“Grand total was: $grand_total”);</p>

<p>//output to the CSV file<br />
 $outline = “$username, $homedir, $in_total, $out_total, $grand_total, $this_month, $this_year”;<br />
 str_log(“Gen: $outline”);<br />
 fwrite($fo, trim($outline) . “n”);<br />
}<br />
mysql_close();</p>

<p>$to = $TO_EMAIL;<br />
$subject = ‘ProFTPd usage report’;<br />
$random_hash = md5(date(‘r’, time()));<br />
$headers = “From: admin@jasonn.comrnReply-To: admin@jasonn.com”;<br />
$headers .= “rnContent-Type: multipart/mixed; boundary=”PHP-mixed-“.$random_hash.”””;<br />
$attachment = chunk_split(base64_encode(file_get_contents($OUTFILE)));<br />
ob_start(); //Turn on output buffering<br />
?&gt;<br />
–PHP-mixed-&lt;?php echo $random_hash; ?&gt;<br />
Content-Type: multipart/alternative; boundary=”PHP-alt-&lt;?php echo $random_hash; ?&gt;”</p>

<p>–PHP-alt-&lt;?php echo $random_hash; ?&gt;<br />
Content-Type: text/plain; charset=”iso-8859-1”<br />
Content-Transfer-Encoding: 7bit</p>

<p>Attached is the usage report CSV for proftpd server.</p>

<p>–PHP-alt-&lt;?php echo $random_hash; ?&gt;<br />
Content-Type: text/html; charset=”iso-8859-1”<br />
Content-Transfer-Encoding: 7bit</p>

<p>Attached is the usage report CSV for proftpd server.</p>

<p>–PHP-alt-&lt;?php echo $random_hash; ?&gt;–</p>

<p>–PHP-mixed-&lt;?php echo $random_hash; ?&gt;<br />
Content-Type: application/zip; name=”&lt;?php echo $OUTFILE; ?&gt;”<br />
Content-Transfer-Encoding: base64<br />
Content-Disposition: attachment</p>

<p>&lt;?php echo $attachment; ?&gt;<br />
–PHP-mixed-&lt;?php echo $random_hash; ?&gt;–</p>

<p>&lt;?php<br />
$message = ob_get_clean();<br />
$mail_sent = @mail( $to, $subject, $message, $headers );<br />
//if the message is sent successfully print “Mail sent”. Otherwise print “Mail failed”<br />
echo $mail_sent ? “Mail sent” : “Mail failed”;<br />
?&gt;<br />
[/sourcecode]</p>

<p>The final thing we need is to have our trasnfer log rotated and then these scripts called on the the last month’s logrotate. For that, edit (or create) the <code class="language-plaintext highlighter-rouge">/etc/logrotate.d/proftpd-basic</code> file and add the following rule to it:</p>

<p>[sourcecode lang=”bash”]<br />
/var/log/proftpd/xferlog</p>
<h1 id="varlogproftpdxferreport">/var/log/proftpd/xferreport</h1>
<p>{<br />
 monthly<br />
 missingok<br />
 rotate 7<br />
 compress<br />
 delaycompress<br />
 # keep 1/2 year worth of logs<br />
 rotate 6<br />
 notifempty<br />
 create 640 root adm<br />
 sharedscripts<br />
 prerotate<br />
 endscript<br />
 postrotate<br />
 # reload could be not sufficient for all logs, a restart is safer<br />
 invoke-rc.d proftpd restart 2&gt;/dev/null &gt;/dev/null || true</p>

<h1 id="call-the-analyzer-and-pass-it-the-last-log-file">call the analyzer and pass it the last log file</h1>
<p>/usr/bin/php /usr/src/ftpan/analyze-proftpd.php /var/log/proftpd/xferlog.1 &gt;&gt; /usr/src/ftpan/analysis.log<br />
 /usr/bin/php /usr/src/ftpan/generate-csv.php &gt;&gt; /usr/src/ftpan/generation.log<br />
 endscript<br />
}<br />
[/sourcecode]</p>

<p>Logrotate should be called daily (our files will be rotated monthly but logrotate itself should be called on a daily basis). If it isn’t enabled already, enable it by adding the following line to <code class="language-plaintext highlighter-rouge">crontab -e</code>.</p>

<p>[sourcecode lang=”bash”]<br />
1 0 * * * /usr/sbin/logrotate /etc/logrotate.conf<br />
[/sourcecode]</p>


      </div>

        <!-- Configure Disqus --></div>
  </main><footer class="footer">
  <span class="text-muted"> recluze | No rights reserved.</span>
</footer>
</body>
</html>