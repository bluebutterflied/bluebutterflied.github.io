<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:400,400i,700&display=swap" rel="stylesheet"> -->
<link href="https://fonts.googleapis.com/css?family=Nunito+Sans:600,600i,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet"> 

<link rel="stylesheet" href="/assets/css/tailwind.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/cards.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100&display=swap" rel="stylesheet">
<title>Enabling Voicemail for A2billing</title>


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-125808593-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125808593-1');
</script>



<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Enabling Voicemail for A2billing | recluze - Nauman (recluze) on Computing, Philosophy and More …</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Enabling Voicemail for A2billing" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="So you’ve setup a2billing and have everything working out, all the DIDs are forwarded to a2billing and all the call plans are set. All you’re missing is a voicemail system. Wait no more. Here’s how to enable voicemail for a2billing users." />
<meta property="og:description" content="So you’ve setup a2billing and have everything working out, all the DIDs are forwarded to a2billing and all the call plans are set. All you’re missing is a voicemail system. Wait no more. Here’s how to enable voicemail for a2billing users." />
<meta property="og:site_name" content="recluze - Nauman (recluze) on Computing, Philosophy and More …" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-02-08T09:25:25+05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Enabling Voicemail for A2billing" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Enabling Voicemail for A2billing","dateModified":"2011-02-08T09:25:25+05:00","datePublished":"2011-02-08T09:25:25+05:00","description":"So you’ve setup a2billing and have everything working out, all the DIDs are forwarded to a2billing and all the call plans are set. All you’re missing is a voicemail system. Wait no more. Here’s how to enable voicemail for a2billing users.","url":"/2011/02/08/enabling-voicemail-for-a2billing/","mainEntityOfPage":{"@type":"WebPage","@id":"/2011/02/08/enabling-voicemail-for-a2billing/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>
  <header class="texture-blue">
    <div class="container"><div class="navbar">
	<ul>
		
		<a href="/"><li  >Home</li></a>
		
		<a href="/about"><li  >About</li></a>
		
		<a href="/learn"><li  >Courses</li></a>
		
	</ul>
</div></div><div class="container">
	<h1>Enabling Voicemail for A2billing</h1>
	<h4 class="post-description"></h4>
	<div class="post-date" style="margin-top:20px">
		Published on Feb 8, 2011
	</div>
	<ul class="post-tags"><li>resources</li><li>Tutorials</li></ul>
</div>
</header>
  <main>
    <div class="container">
      <div class="post-container">
          <p>So you’ve setup a2billing and have everything working out, all the DIDs are forwarded to a2billing and all the call plans are set. All you’re missing is a voicemail system. Wait no more. Here’s how to enable voicemail for a2billing users.</p>

<p>First, you need to change the A2billing class to enable it to forward unavailable or unattended calls to the voicemail. For that, edit the <code class="language-plaintext highlighter-rouge">[a2billing-home]/common/lib/Class.A2billing.php file</code> file. The two functions that need changing are the <code class="language-plaintext highlighter-rouge">call_did</code> and <code class="language-plaintext highlighter-rouge">call_sip_buddies</code>. In version 1.8.5, the changes are around line 1160 and 1330. You can just search for the following code to reach there. (Remember, there are two instances that need changing.)</p>

<p>[sourcecode lang=”php”]<br />
//# Ooh, something actually happend!<br />
if ($dialstatus == “BUSY”) {<br />
[/sourcecode]</p>

<p>Now, it needs to be changed so that the caller is redirected to the voicemail if the <code class="language-plaintext highlighter-rouge">dialstatus</code> is <code class="language-plaintext highlighter-rouge">CHANUNAVAIL</code>, <code class="language-plaintext highlighter-rouge">CONGESTION</code> or <code class="language-plaintext highlighter-rouge">NOANSWER</code>. Note that we need to get rid of the existing checks for these statuses and introduce our own code. The complete code would be as follows:</p>

<p>[sourcecode lang=”php”]<br />
$answeredtime.”-DIALSTATUS=”.$dialstatus.”]”);<br />
$lang = “en”;<br />
if (($dialstatus ==”CHANUNAVAIL”) || ($dialstatus == “CONGESTION”) ||($dialstatus == “NOANSWER”) || ($dialstatus ==”BUSY”) )<br />
{<br />
 // The following section will send the caller to VoiceMail with the unavailable priority.<br />
 $did_ext_number = substr($this-&gt;destination, 4);<br />
 // get the actual did<br />
 // BAD but a hack for now<br />
 $db_host = $this-&gt;config[‘database’][‘hostname’];<br />
 $db_user = $this-&gt;config[‘database’][‘user’];<br />
 $db_pass = $this-&gt;config[‘database’][‘password’];<br />
 $db_sele = $this-&gt;config[‘database’][‘dbname’];</p>

<p>mysql_connect($db_host, $db_user, $db_pass);<br />
 @mysql_select_db($db_sele) or die( “Unable to access database”);<br />
 $query = “select S.name, D.did, C.language from cc_sip_buddies S, cc_card C , cc_did_destination E, cc_did D<br />
 where S.id_cc_card =C.id and E.id_cc_card = C.id and E.id_cc_did = D.id and<br />
 S.name = ‘$did_ext_number’;”;</p>

<p>$result = mysql_query($query);<br />
 $did_number = $did_ext_number;<br />
 if ($row = mysql_fetch_array($result)){<br />
 if($dialstatus ==”BUSY”)<br />
 $did_number = “b”.$row[“did”];<br />
 else<br />
 $did_number = “u”.$row[“did”];</p>

<p>// set the language<br />
 $lang = $row[“language”];<br />
 }</p>

<p>$this -&gt; write_log(“[STATUS] CHANNEL UNAVAILABLE - DIVERT TO VOICEMAIL ($did_number)”);<br />
 $lang_str = “LANGUAGE()=$lang”;<br />
 $agi-&gt;exec (Set, $lang_str);<br />
 $agi-&gt; exec(VoiceMail,$did_number);<br />
}</p>

<p>// the old code for BUSY is commented out<br />
//# Ooh, something actually happend!<br />
/* if ($dialstatus == “BUSY”) {<br />
 $answeredtime = 0;<br />
 if ($this-&gt;agiconfig[‘busy_timeout’] &gt; 0)<br />
 $res_busy = $agi-&gt;exec(“Busy “.$this-&gt;agiconfig[‘busy_timeout’]);<br />
 $agi-&gt; stream_file(‘prepaid-isbusy’, ‘#’);<br />
} elseif ($this-&gt;dialstatus == “NOANSWER”) {<br />
 $answeredtime = 0;<br />
 $agi-&gt; stream_file(‘prepaid-noanswer’, ‘#’);<br />
} else<br />
*/</p>

<p>if ($dialstatus == “CANCEL”) {<br />
 $answeredtime = 0;<br />
} elseif ($dialstatus == “ANSWER”) {<br />
 $this -&gt; debug( DEBUG, $agi, __FILE__, __LINE__, “-&gt; dialstatus : $dialstatus, answered time is “.$answeredtime.” n”);<br />
} elseif ($k+1 == $sip_buddies+$iax_buddies) {<br />
 $prompt=”prepaid-dest-unreachable”;<br />
 $agi-&gt; stream_file($prompt, ‘#’);<br />
}</p>

<p>/*<br />
// AGAIN, the old code for the statuses is commented out<br />
if (($dialstatus == “CHANUNAVAIL”) || ($dialstatus == “CONGESTION”))<br />
 continue;<br />
*/<br />
[/sourcecode]</p>

<p>Find the similar code in the other function and change that too.</p>

<p>Now, we need to change the asterisk voicemail configuration to recognize the DID as a mailbox. For that, first enable asterisk realtime. (It’s a simple matter of compiling asterisk and then compiling asterisk-addons.) After that is done, change the <code class="language-plaintext highlighter-rouge">/etc/asterisk/res_mysql.conf</code> file as follows:</p>

<p>[sourcecode lang=”bash”]<br />
[general]<br />
dbhost = 127.0.0.1<br />
dbname = a2billingdb<br />
dbuser = [asteriskuser]<br />
dbpass = [yourpassword]<br />
dbport = 3306<br />
dbsock = /tmp/mysql.sock<br />
[/sourcecode]</p>

<p>Also, in the <code class="language-plaintext highlighter-rouge">/etc/asterisk/extconfig.conf</code> add the following line:</p>

<p>[sourcecode]<br />
voicemail =&gt;mysql,a2billingdb,voicemail_users<br />
[/sourcecode]</p>

<p>This will make sure that the voicemail application tries to find the list of mailboxes in the <code class="language-plaintext highlighter-rouge">voicemail_users</code> table in the <code class="language-plaintext highlighter-rouge">a2billingdb</code>. Let’s create that table:</p>

<p>[sourcecode lang=”sql”]<br />
CREATE TABLE <code class="language-plaintext highlighter-rouge">voicemail_users</code> (<br />
<code class="language-plaintext highlighter-rouge">uniqueid</code> int(11) NOT NULL auto_increment,<br />
<code class="language-plaintext highlighter-rouge">customer_id</code> int(20) NOT NULL default ‘0’,<br />
<code class="language-plaintext highlighter-rouge">context</code> varchar(50) NOT NULL default ‘’,<br />
<code class="language-plaintext highlighter-rouge">mailbox</code> varchar(20) NOT NULL default ‘0’,<br />
<code class="language-plaintext highlighter-rouge">password</code> varchar(20) NOT NULL default ‘8888’,<br />
<code class="language-plaintext highlighter-rouge">fullname</code> varchar(50) NOT NULL default ‘’,<br />
<code class="language-plaintext highlighter-rouge">email</code> varchar(50) NOT NULL default ‘’,<br />
<code class="language-plaintext highlighter-rouge">pager</code> varchar(50) NOT NULL default ‘’,<br />
<code class="language-plaintext highlighter-rouge">stamp</code> timestamp(14) NOT NULL,<br />
PRIMARY KEY (<code class="language-plaintext highlighter-rouge">uniqueid</code>),<br />
KEY <code class="language-plaintext highlighter-rouge">mailbox_context</code> (<code class="language-plaintext highlighter-rouge">mailbox</code>,<code class="language-plaintext highlighter-rouge">context</code>)<br />
) TYPE=MyISAM;<br />
[/sourcecode]</p>

<p>… and synchronize it with the rest of the a2billing database so that the users can use their DID and SIP secret for their mailboxes.</p>

<p>[sourcecode lang=”sql”]<br />
insert into voicemail_users(customer_id,context,mailbox, password, fullname, email)<br />
select S.id_cc_card, ‘default’, D.did, S.secret, concat(C.lastname,’ ‘,C.firstname) fullname, C.email<br />
from cc_sip_buddies S, cc_card C , cc_did_destination E, cc_did D<br />
where S.id_cc_card =C.id<br />
and E.id_cc_card = C.id<br />
and E.id_cc_did = D.id;<br />
[/sourcecode]</p>

<p>You might want to add the following cronjob to perform this synchronization automatically.</p>

<p>[sourcecode lang=”bash”]<br />
0 * * * * mysql -ua2billinguser -p[yourpassword] -D a2billingdb -e “truncate table voicemail_users; insert into voicemail_users(customer_id,context,mailbox, password, fullname, email) select S.id_cc_card, ‘default’, D.did, S.secret, concat(C.lastname,’ ‘,C.firstname) fullname, C.email from cc_sip_buddies S, cc_card C , cc_did_destination E, cc_did D where S.id_cc_card =C.id and E.id_cc_card = C.id and E.id_cc_did = D.id ;”<br />
[/sourcecode]</p>

<p>That should fix the whole voicemail recording business. However, we still need to enable the voicemail interface provided by FreePBX. Since the ARI does not support asterisk realtime, we need to change the <code class="language-plaintext highlighter-rouge">login.php</code> file in <code class="language-plaintext highlighter-rouge">/var/www/html/admin/includes</code> folder. Search out the code where the authentication is being done. The code first tries to autenticate using the configuration file. It then tries SIP authentication (whatever that is). After that, we insert our own DB authentication like so:</p>

<p>[sourcecode lang=”php”]<br />
// check database login: recly<br />
if(!$auth){<br />
 // BAD but a hack for now<br />
 $db_host = “localhost”;<br />
 $db_user = “a2billinguser”;<br />
 $db_pass = “[yourpassword]”;<br />
 $db_sele = “a2billingdb”;</p>

<p>mysql_connect($db_host, $db_user, $db_pass);<br />
 @mysql_select_db($db_sele) or die( “Unable to access database”);</p>

<p>$query = “select * from <code class="language-plaintext highlighter-rouge">voicemail_users</code> where mailbox = ‘$username’ and password= ‘$password’”;<br />
 $result = mysql_query($query);</p>

<p>if ($row = mysql_fetch_array($result)){<br />
 $auth = true;<br />
 $extension = $row[“mailbox”];<br />
 $outboundCID = “”;<br />
 $displayname = $row[“fullname”];<br />
 $vm_password = $row[“password”];<br />
 $category = “”;<br />
 $context = $row[“context”];<br />
 $voicemail_enabled = “1”;<br />
 $voicemail_email_address = $row[“email”];<br />
 $voicemail_pager_address = $row[“pager”];<br />
 $voicemail_email_enable = “yes”;<br />
 $voicemail_email = array(‘’);<br />
 $default_page = $ARI_DEFAULT_USER_PAGE;<br />
 }<br />
}<br />
// the original login failure lines follow</p>

<p>// let user know bad login<br />
if (!$auth) {<br />
 $_SESSION[‘ari_error’] = _(“Incorrect Username or Password”);<br />
}<br />
[/sourcecode]</p>

<p>And that should enable you to login using your ARI. One final thing: You might also want to enable your users to check their mailbox. For that, change the dialplan in <code class="language-plaintext highlighter-rouge">extensions_a2billing.conf</code>:</p>

<p>[sourcecode lang=”bash”]<br />
[a2billing]<br />
exten =&gt; 9999,1,VoicemailMain()<br />
exten =&gt; _X.,1,Answer<br />
exten =&gt; _X.,n,Wait(1)<br />
exten =&gt; _X.,n,DeadAGI(a2billing.php|1)<br />
exten =&gt; _X.,n,Hangup<br />
[/sourcecode]</p>

<p>Now your users can dial 9999 and check up on their voicemail.</p>


      </div>

        <!-- Configure Disqus --></div>
  </main><footer class="footer">
  <span class="text-muted"> recluze | No rights reserved.</span>
</footer>
</body>
</html>